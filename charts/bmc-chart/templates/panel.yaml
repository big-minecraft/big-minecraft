apiVersion: apps/v1
kind: Deployment
metadata:
  name: fullstack-app
  labels:
    {{- include "common.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fullstack-app
  template:
    metadata:
      labels:
        app: fullstack-app
    spec:
      serviceAccountName: kubectl-sa
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/master
                    operator: Exists
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"
      volumes:
        - name: app-source
          emptyDir:
            medium: Memory
        - name: host-root
          hostPath:
            path: /
            type: Directory
        - name: kube-config
          emptyDir: {}
      securityContext:
        fsGroup: 1000
      initContainers:
        - name: fetch-source
          image: curlimages/curl:latest
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              mkdir -p /tmp/source
              mkdir -p /usr/src/app
              curl -L -o /tmp/source/app.tar.gz https://api.github.com/repos/BigMinecraftFramework/bmc-panel/tarball/main && \
              cd /tmp/source && \
              tar -xzf app.tar.gz && \
              EXTRACTED_DIR=$(ls -d */ | head -n 1) && \
              cp -r /tmp/source/$EXTRACTED_DIR/* /usr/src/app/ && \
              chown -R 1000:1000 /usr/src/app && \
              chmod -R 755 /usr/src/app
          volumeMounts:
            - name: app-source
              mountPath: /usr/src/app
      containers:
        - name: react-container
          image: node:18-alpine
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          workingDir: /usr/src/app/client
          command:
            - sh
            - -c
            - |
              cd /usr/src/app/client && \
              export NODE_ENV=development && \
              export PUBLIC_URL=/ && \
              export WDS_SOCKET_PORT=0 && \
              export BROWSER=none && \
              npm install && \
              npm run start
          ports:
            - containerPort: 3000
          env:
            - name: DANGEROUSLY_DISABLE_HOST_CHECK
              value: "true"
          volumeMounts:
            - name: app-source
              mountPath: /usr/src/app
            - name: host-root
              mountPath: /host-root
              readOnly: false

        - name: node-container
          image: node:18-alpine
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          workingDir: /usr/src/app/server
          command:
            - sh
            - -c
            - |
              apk add --no-cache bash && \
              cd /usr/src/app/server && \
              export NODE_ENV=production && \
              npm install && \
              npm run start
          ports:
            - containerPort: 3001
          env:
            - name: INITIAL_INVITE_CODE
              value: {{ .Values.global.inviteCode }}
            - name: PANEL_HOST
              value: {{ .Values.global.panelDomain }}
            - name: MARIADB_PASSWORD
              value: {{ .Values.global.mariaDBPassword }}
            - name: MONGO_INITDB_ROOT_PASSWORD
              value: {{ .Values.global.mongoDBPassword }}
            - name: BMC_PATH
              value: {{ .Values.global.bmcPath }}
          volumeMounts:
            - name: app-source
              mountPath: /usr/src/app
            - name: host-root
              mountPath: /host-root
              readOnly: false
---
apiVersion: v1
kind: Service
metadata:
  name: fullstack-service
  labels:
    {{- include "common.labels" . | nindent 4 }}
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /api$1
spec:
  selector:
    app: fullstack-app
  ports:
    - name: frontend
      protocol: TCP
      port: 80
      targetPort: 3000
    - name: backend
      protocol: TCP
      port: 3001
      targetPort: 3001
      # Add a new port specifically for API
    - name: api
      protocol: TCP
      port: 3002
      targetPort: 3001
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fullstack-ingress
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "15"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/connection-upgrade: "true"
    nginx.ingress.kubernetes.io/upgrade: "websocket"
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Add cert-manager annotations
    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # Use your ClusterIssuer name
    # Force SSL
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - {{ .Values.global.panelDomain }}
    secretName: fullstack-tls-secret  # cert-manager will create this secret
  rules:
    - host: {{ .Values.global.panelDomain }}
      http:
        paths:
          - path: /api/(.*)
            pathType: Prefix
            backend:
              service:
                name: fullstack-service
                port:
                  number: 3002
          - path: /(.*)
            pathType: Prefix
            backend:
              service:
                name: fullstack-service
                port:
                  number: 80
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: default
  namespace: metallb-system
  labels:
    {{- include "common.labels" . | nindent 4 }}
spec:
  addresses:
    - {{ .Values.global.loadBalancerIP }}/32
  autoAssign: true
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: default
  namespace: metallb-system
spec:
  ipAddressPools:
    - default
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Email address used for ACME registration
    email: your-email@contact.com  # Replace with your email
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Name of a secret used to store the ACME account private key
      name: letsencrypt-prod-private-key
    # Add a single challenge solver, HTTP01 using nginx
    solvers:
    - http01:
        ingress:
          class: nginx